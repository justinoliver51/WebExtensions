'''
Created on Apr 13, 2014

@author: justinoliver
'''

from datetime import datetime, date, timedelta
import time
import sys
import subprocess
import urllib2
import urllib

class JasonBondsParser:
    def __init__(self):
        return
    
    def getTrade(self, tradeBody, startingIndex):
        spacesCount = 0
        index = startingIndex
    
        # Find the end point
        while (index < len(tradeBody)) and (spacesCount < 5) and (tradeBody[index] != '\n') and (tradeBody[index] != '\r') :
            if tradeBody[index] == ' ':
                spacesCount = spacesCount + 1
            index = index + 1

        index = index - 1
        exclude = set(string.punctuation)
        tradeList = ''.join(ch for ch in tradeBody[startingIndex:index] if (ch == '.') or (ch == '$') or ((ch not in exclude) and (ch != '\r') and (ch != '\n')))  # FIXME: Need to leave in '.'
    
        if( (len(tradeList.split(' ')) == 5) and (tradeList.split(' ')[4].find('$') == 0) ):
            index = tradeList.find('$')
            price = ''.join(ch for ch in tradeList.split(' ')[4] if (ch == '$') or (ch == '.') or (ch in string.digits))
            tradeList = tradeList[:index] + price
        
        if tradeList[-1] == '.':
            tradeList = tradeList[:-1]
        
        return tradeList
    
    def parseTrade(self, tradeString = ""):
        price = ""
        article = ""
        index = 0
        
        if tradeString.lower().find('bought') >= 0:
            index = tradeString.lower().find('bought')
        elif tradeString.lower().find('added') >= 0:
            index = tradeString.lower().find('added')
        elif tradeString.lower().find('taking') >= 0:
            index = tradeString.lower().find('taking')
        else:
            return None
        
        # Get the trade information
        trade = self.getTrade(tradeString, index)
            
        if(len(trade.split(' ')) == 5):
            price = trade.split(' ')[4]
            article = trade.split(' ')[3]
            
        if(price.find('$') >= 0 and article == 'at'):
            trade = trade.replace('$', '')
            
            # If this is a bond blow ups, inform the server
            if(tradeString.lower().find('bond blow ups') >= 0):
                trade = "Bond Blow Ups " + trade
                
            return trade
        return None

def debug():
    print 'debug!'
    time.sleep(1)

    # Copy the alert to the clipboard
    doubleClick(Pattern("1397436587563.png").targetOffset(-44,20))
    type('a', KeyModifier.CMD)  
    type('c', KeyModifier.CMD) 
    
    cb = getClipboardData() #Env.getClipboard()
    print "The clipboard contains: " + str(cb)

def getClipboardData(): 
    p = subprocess.Popen(['pbpaste'], stdout=subprocess.PIPE) 
    retcode = p.wait() 
    data = p.stdout.read() 
  
    return data

def newAlert(region):
    # Get the data from the chatroom 
    tradeData = getTradeData(region)

    # Parse the message for trade information
    parser = JasonBondsParser()
    newTrade = parser.parseTrade(tradeData)

    # If we succcessfully parsed a trade, send it to the server
    if newTrade != None:
        sendTradeToServer(newTrade)


def getTradeData(region):
    print 'new alert!'

    # Copy the alert to the clipboard
    if region.exists(Pattern("JasonBondsAnnouncement.png")):
        region.doubleClick(Pattern("JasonBondsAnnouncement.png").targetOffset(-83,19))
        type('a', KeyModifier.CMD)  
        type('c', KeyModifier.CMD) 
    else:
        return None
    
    tradeData = getClipboardData() #Env.getClipboard()
    return tradeData

def sendTradeToServer(newTrade):
    # Build the url
    paramDic = {'traderID':         'Jason Bond',
                'newTrade':         newTrade,
                'realTimeSystem':   'websiteMonitor'
                }
    url = "http://localhost:8080/IBTradingServer/RemoteProcedureCallsServlet?"
    
    if debugFlag == True:
        paramDic['traderID'] = 'Justin Oliver'
        
    encodedParams = urllib.urlencode(paramDic)
    query = url + encodedParams
    
    # Send the alert
    print query
    response = urllib2.urlopen(query).read()

### MAIN ###
def main(args):
    debugFlag = False

    if debugFlag == True:
        exitFlag = False
        debugFunctionFlag = False
        loopIndex = 0
        
        if debugFunctionFlag == True:
            debug()

        if exitFlag == True:
            sys.exit()
    
    # Make sure we are in the chat room
    if exists("1381195946550.png"):
        click("1381195946550.png")
        click("1397444289724.png") 
    else:
        print "Jason Bonds Chatroom isn't running!"
        sys.exit()

    # Infinite loop looking at chat room
    region = Region(480,684,1067,202)
    
    print datetime.now().time()
    while datetime.now().strftime('%H:%M') < '23:00':     
        time.sleep(1)
        loopIndex += 1
        if loopIndex == 5 and debugFlag == True:
            break

        try:
            # Make sure we're in 'omniTweet'
            # If an announcement has appeared
            if region.exists("JasonBondsAnnouncement.png"):
                print 'a'
                newAlert(region)
            else:
                print 'e'
            
            # Look for the announcement not from Jason Bonds
            if region.exists("1397191952703.png"):
                print 'b'
                # If this happens to be from Jason, call the alert 
                if region.exists("JasonBondsAnnouncement.png"):
                    print 'c'
                    newAlert(region)
                else:
                    print 'd'
                    region.click("1397191952703.png")
            else:
                print 'f'
        except Exception, inst:
            print type(inst)     # the exception instance
            print inst           # __str__ allows args to printed directly            
if __name__ == '__main__':
    main(sys.argv)

# vim: ts=8 et sw=4 sts=4 background=light