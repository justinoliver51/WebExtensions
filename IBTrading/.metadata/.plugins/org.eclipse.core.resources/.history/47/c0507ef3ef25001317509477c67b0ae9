// Element class names
var commentsClassName = '.comments';
var newsClassName = '.newsletter';
var connectedClassName = '.green';
var chatGuruClassName = '.chatWidgetText chatWidgetComm'; //class="chatWidgetText chatWidgetGuru"
var chatRoomClassName = '.dijitContentPane chatWidgetMessages chatWidget-child chatWidget-dijitContentPane chatWidgetPane dijitAlignCenter';
var chatRoomID = 'dijit_layout_ContentPane_3';

// Time related variables
var tenthSeconds = 0;
var numMilliseconds = 100;

// Counters
var numItems = $(commentsClassName).length;
var numComments;
var numTradeAlerts;


var lastTradeAlert;
var lastComment;

// Debug
var debug = true;
var initiateTrade = false;

chrome.runtime.onMessage.addListener(
	function(request,sender,senderResponse)
	{
		// If we've received a trade update, let the server know!
		if(request.msg==="Update Received")
		{
			console.log(request.text);
		}
	}
);

function go () {
	// Log number of seconds every five minutes
	if((tenthSeconds % 3000) == 0)
	{
		//console.log("Time: " + new Date());
		
		// Print useful debug information
		if(debug == true)
		{
			console.log("numTradeAlerts = ", numTradeAlerts);
			console.log("numComments = ", numComments);
			console.log("lastTradeAlert = ", lastTradeAlert);
			
			if(tradeArray != null)
			{
				console.log("The first trade alert is: ", tradeArray[0].innerHTML.split("<a")[0]);
				console.log("The first comment is: ", tradeArray[numTradeAlerts].innerHTML.split("<a")[0]);
			}
		}
	}

	// Get the trade array and update the time
	var tradeArray = $(commentsClassName);
	var newsArray = $(newsClassName);
	var chatRoom = $('#dijit_layout_ContentPane_3');
	
	if(chatRoom != null && tenthSeconds % 30 )
	{
		var chatRoomArray = chatRoom.children();
		//console.log(chatRoomArray[0].outerText + " at time: " + new Date());
		console.log(chatRoom.outerText + " at time: " + new Date());
	}
	
/*	var connected = $(connectedClassName)[0].innerHTML;
	
	
	console.log($(connectedClassName)[0]);
	console.log(connected);

	// Monitor the page's connection
	if(connected.search("NOT CONNECTED") != -1)
	{
		chrome.runtime.sendMessage({msg:"Refresh",text:tradeUpdate},function(response){});
	}
*/

	// If we have just started running this script, initialize our variables
	if( (numItems == 0) && (tradeArray.length > 0) )
	{
		numItems = tradeArray.length;
		numComments = 10;
		numTradeAlerts = numItems - numComments;
		lastComment = tradeArray[numTradeAlerts].innerHTML.split("<a")[0];
		lastTradeAlert = tradeArray[0].innerHTML.split("<a")[0];
		console.log(lastComment);

		if(initiateTrade == true)
		{
			numItems = 0; // Instigating an 'Added'
			lastTradeAlert = ""; //Instigating a 'Bought'
			numTradeAlerts = numTradeAlerts - 1; // Subtracts an alert because there really isn't a new one
		}
	}

	// If there has been a new trade alert or comment
	if(tradeArray.length > numItems)
	{
		// local variables
		var tradeUpdate;
		var trader = null;

		// Set the trader
		trader = newsArray[0].innerHTML.split("<a")[0];

		// Update the number of items
		numItems = tradeArray.length;

		// Is this a new trade
		if(lastTradeAlert != tradeArray[0].innerHTML.split("<a")[0])
		{
			console.log("New trade alert! Time: " + new Date());

			// Update the global variables
			lastTradeAlert = tradeArray[0].innerHTML.split("<a")[0]; // Grabs the newest alert
			numTradeAlerts = numTradeAlerts + 1;
			numComments = numItems - numTradeAlerts; // Some alerts are posted to both
			
			// Access the latest trade text
			splitHTML = tradeArray[numTradeAlerts].innerHTML.split("<a"); 
			tradeUpdate = splitHTML[0];
			console.log(tradeUpdate);

			// Send message to the background with the data
			chrome.runtime.sendMessage({msg:trader,text:tradeUpdate},function(response){});
		}
		// Is this an 'Added' comment
		else if(tradeArray[numTradeAlerts].innerHTML.split("<a")[0].indexOf("Added") >= 0)
		{
			console.log("Added comment! Time: " + new Date());

			// Access the latest comment text
			splitHTML = tradeArray[numTradeAlerts].innerHTML.split("<a");
			tradeUpdate = splitHTML[0];
			console.log(tradeUpdate);

			//
			lastComment = tradeUpdate;
			numComments = numComments + 1;

			// Send message to the background with the data
			chrome.runtime.sendMessage({msg:trader,text:tradeUpdate},function(response){});
		}
		// This is nothing
		else
		{
			console.log("False alarm!");
			numComments = numComments + 1;
		}

		// Print useful debug information
		if(debug == true)
		{
			console.log("numTradeAlerts = ", numTradeAlerts);
			console.log("numComments = ", numComments);

			console.log("The first trade alert is: ", tradeArray[0].innerHTML.split("<a")[0]);
			console.log("The first comment is: ", tradeArray[numTradeAlerts].innerHTML.split("<a")[0]);
		}
	}

	tenthSeconds++;
	setTimeout(go, numMilliseconds);
}
go()